@model SME.SR.Infra.RelatorioAcompanhamentoAprendizagemAlunoDto

@{
    int contadorQuebrarPagina = 0;
    int contadorMaximoLinhasPorPagina = 53;
    int contadorMaximoDescricao = 0;
    bool quebrou = false;
    int contadorMaximoCaracteresPorLinhaPercurso = 120;
    int contadorMaximoCaracteresPorLinhaOcorrencias = 62;

    Microsoft.AspNetCore.Html.IHtmlContent MontarQuebrarPagina()
    {
        var str = $@"<div style='page-break-before:always' />";
        return Html.Raw(str);
    }

    string EspacoEmBranco()
    {
        if (quebrou)
        {
            return "";
        }

        return @"<table><tbody><tr><td height='17px' width='100%' class='tabela-cabecalho sem-border-bottom'></td></tr></tbody></table>";
    }

    bool VerificaQuebra(int numeroLinhasDescricao = 0)
    {
        if (contadorQuebrarPagina + numeroLinhasDescricao >= contadorMaximoLinhasPorPagina)
        {
            contadorQuebrarPagina = 0;
            contadorQuebrarPagina = contadorQuebrarPagina + 1;
            quebrou = true;
            return true;
        }
        quebrou = false;
        return false;

    }

    int CalcularLinhas(int valorLinha = 0, int caracteres = 120)
    {
        if (contadorMaximoDescricao == 1)
        {
            contadorMaximoDescricao = 0;
        }
        else
        {
            contadorMaximoDescricao++;
        }

        if (valorLinha > 0)
        {
            if (valorLinha < caracteres)
            {
                return 1;
            }
            var valorMod = valorLinha % caracteres;
            int valorInt = valorLinha / caracteres;
            if (valorMod > 0)
            {
                return valorInt + 1;
            }
            else
            {
                return valorInt;
            }
        }

        return 1;
    }

    string MontarTitulo(string titulo)
    {
        <table class='tabela-alunos'>
            <thead>
                <tr>
                    <td width='100%' class='centralizar sem-border-bottom negrito'>@titulo</td>
                </tr>
            </thead>
        </table>

        contadorQuebrarPagina++;

        return "";
    }

    void QuebrarLinhas(int numeroQuebras = 2, string estudante = "", string titulo = "")
    {
        bool quebra = VerificaQuebra(numeroQuebras);

        if (quebra)
        {
            @Html.Raw("</tbody></table>");
            @Html.Raw("<div style='page-break-before:always'></div>");

            if (!String.IsNullOrEmpty(estudante))
            {
                @Html.Raw(MontarTitulo(estudante));
            }

            if (!String.IsNullOrEmpty(titulo))
            {
                @Html.Raw(MontarTitulo(titulo));
            }

            @Html.Raw("<table class='tabela-alunos'>");

            contadorQuebrarPagina = contadorQuebrarPagina + numeroQuebras;
        }
    }

    string MontarEstudantes(SME.SR.Infra.RelatorioAcompanhamentoAprendizagemAlunoDto aluno)
    {
        MontarTitulo(aluno.Nome);

        <table class='tabela-alunos'>
            <thead>
                <tr>
                    <td class='centralizar sem-border-bottom negrito'>DATA DE NASCIMENTO</td>
                    <td class='centralizar sem-border-bottom negrito'>CÓDIGO EOL</td>
                    <td class='centralizar sem-border-bottom negrito'>SITUAÇÃO</td>
                    <td class='centralizar sem-border-bottom negrito'>RESPONSÁVEL</td>
                    <td class='centralizar sem-border-bottom negrito'>CONTATO</td>
                </tr>
            </thead>

            @{ contadorQuebrarPagina++; }

            <tbody>
                <tr>
                    <td width="20%" class='centralizar'>@aluno.DataNascimento</td>
                    <td width="14%" class='centralizar'>@aluno.CodigoEol</td>
                    <td width="22%" class='centralizar' style="padding:3px;">@aluno.Situacao</td>
                    <td width="22%" class='centralizar'>@aluno.Responsavel</td>
                    <td width="22%" class='centralizar'>@aluno.Telefone</td>
                </tr>
            </tbody>
        </table>

        return "";
    }

    string MontarFotos(SME.SR.Infra.RelatorioAcompanhamentoAprendizagemAlunoDto aluno)
    {
        MontarTitulo("FOTOS");

        <table class='tabela-alunos sem-border-bottom'>
            <tbody>
                <tr>
                    @{
                        for (int i = 0; i < 3; i++)
                        {
                            @if (aluno.Fotos.ElementAtOrDefault(i) != null)
                            {
                                <td width="33%" class='centralizar'>
                                    <img style="margin:3px; max-width: 257px;" src="@aluno.Fotos[i].Caminho" height="180px" />
                                </td>
                            }
                            else
                            {
                                <td width="33%" class='centralizar'>
                                </td>
                            }
                        }
                    }
                </tr>
            </tbody>
        </table>

        return "";
    }

    string MontarFrequencia(SME.SR.Infra.RelatorioAcompanhamentoAprendizagemAlunoDto aluno)
    {
        MontarTitulo("FREQUÊNCIA");

        <table class='tabela-alunos'>
            <thead>
                <tr>
                    <td class='centralizar sem-border-bottom negrito'>BIMESTRE</td>
                    <td class='centralizar sem-border-bottom negrito'>AULAS</td>
                    <td class='centralizar sem-border-bottom negrito'>AUSÊNCIAS</td>
                    <td class='centralizar sem-border-bottom negrito'>FREQUÊNCIA</td>
                </tr>
            </thead>

            @{ contadorQuebrarPagina++; }

            <tbody>

                @foreach (var frequencia in aluno.Frequencias)
                {
                    <tr>

                        <td width="25%" class='centralizar'>@frequencia.Bimestre</td>
                        <td width="25%" class='centralizar'>@frequencia.Aulas</td>
                        <td width="25%" class='centralizar'>@frequencia.Ausencias</td>
                        <td width="25%" class='centralizar'>@frequencia.Frequencia</td>
                    </tr>

                    contadorQuebrarPagina++;

                    QuebrarLinhas(0, aluno.Nome);
                }

            </tbody>
        </table>

        return "";
    }

    string MontarCabecalhoPercursoIndividual() { 
        return $@"<table class='tabela-alunos sem-border-top'>
        <thead>
        <tr>
        <td width='100%' class='centralizar negrito'>PERCURSO INDIVIDUAL DA CRIANÇA</td>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td class='alinhar-esquerda espaco-esquerda-15 espaco-esquerda-15'>";
    }

    string MontarPercursoIndividual(string percursoIndividual, string estudante)
    {
        @Html.Raw(MontarCabecalhoPercursoIndividual());

        contadorQuebrarPagina++;
        var iContadorCaracteres = 0;

        @while (iContadorCaracteres != percursoIndividual.Length)
        {
            if (contadorQuebrarPagina + 1 > contadorMaximoLinhasPorPagina)
            {
                contadorQuebrarPagina = 0;
                @Html.Raw(MontarRodapeTabela());
                @Html.Raw("</tbody></table>");
                @Html.Raw("<div style='page-break-before:always'></div>");

                if (!String.IsNullOrEmpty(estudante))
                {
                    @Html.Raw(MontarTitulo(estudante));
                }

                @Html.Raw(MontarCabecalhoPercursoIndividual());
            }
            else
            {
                var qntCaracteresParaBuscar = percursoIndividual.Length - iContadorCaracteres < contadorMaximoCaracteresPorLinhaPercurso ? percursoIndividual.Length - iContadorCaracteres : contadorMaximoCaracteresPorLinhaPercurso;
                var textParaExibir = percursoIndividual.Substring(iContadorCaracteres, qntCaracteresParaBuscar);
                iContadorCaracteres += textParaExibir.Length;
                <span>@Html.Raw(textParaExibir)</span>
            }
            contadorQuebrarPagina++;
        }

        @Html.Raw(MontarRodapeTabela());

        return "";
    }

    string MontarObservacoes(string observacao)
    {
        <table class='tabela-alunos sem-border-top'>
            <thead>
                <tr>
                    <td width='100%' class='centralizar negrito'>OBSERVAÇÕES</td>
                </tr>
            </thead>

            @{ contadorQuebrarPagina++; }

            <tbody>
                <tr>
                    <td class="alinhar-esquerda espaco-esquerda-15">
                        @observacao
                    </td>
                </tr>
            </tbody>
        </table>

        return "";
    }

    string MontarSubTituloOcorrencias()
    {
        <thead>
            <tr>
                <th class="centralizar sem-border-bottom negrito">DATA DA OCORRÊNCIA</th>
                <th class="centralizar sem-border-bottom negrito">TIPO</th>
                <th class="centralizar sem-border-bottom negrito">DESCRIÇÃO DA OCORRÊNCIA</th>
            </tr>
        </thead>
        return "";
    }

    string MontarOcorrenciasNovo(string descricaoOcorrencia, string estudante, string titulo, string data, string tipo, string subTitulo)
    {
        var iContadorCaracteres = 0;
        @while (iContadorCaracteres != descricaoOcorrencia.Length)
        {
            if (contadorQuebrarPagina + 1 >= contadorMaximoLinhasPorPagina)
            {
                contadorQuebrarPagina = 0;
                @Html.Raw("</td></tr></tbody></table>")
                @Html.Raw("</tbody></table>");
                @Html.Raw("<div style='page-break-before:always'></div>");

                if (!String.IsNullOrEmpty(estudante))
                {
                    @Html.Raw(MontarTitulo(estudante));
                    @Html.Raw(MontarTitulo(titulo))
                    @Html.Raw("<table class='tabela-alunos'>")
                    @Html.Raw(MontarSubTituloOcorrencias())
                    @Html.Raw("<tbody>")
                    @Html.Raw(MontarCabecalhoOcorrencias(data, tipo, subTitulo))
                    @Html.Raw("<tr><td class='alinhar-esquerda espaco-esquerda-15'>")
                    contadorQuebrarPagina += 2;
                }
            }
            else
            {
                var qntCaracteresParaBuscar = descricaoOcorrencia.Length - iContadorCaracteres < contadorMaximoCaracteresPorLinhaOcorrencias ? descricaoOcorrencia.Length - iContadorCaracteres : contadorMaximoCaracteresPorLinhaOcorrencias;
                var textParaExibir = descricaoOcorrencia.Substring(iContadorCaracteres, qntCaracteresParaBuscar);
                iContadorCaracteres += textParaExibir.Length;

                @Html.Raw(textParaExibir)
            }
        }

        return "";
    }

    string MontarCabecalhoOcorrencias(string data, string tipo, string subTitulo)
    {
        <tr>
            <td rowspan="2" width="15%">@data</td>
            <td rowspan="2" width="15%">@tipo</td>
            <td class="alinhar-esquerda espaco-esquerda-15">@subTitulo</td>
        </tr>

        return "";
    }

    string MontarOcorrencias(SME.SR.Infra.RelatorioAcompanhamentoAprendizagemAlunoDto aluno)
    {
        var tituloOcorrencias = "OCORRÊNCIAS";

        MontarTitulo(tituloOcorrencias);

        <table class='tabela-alunos'>
            @Html.Raw(MontarSubTituloOcorrencias())

            @{ contadorQuebrarPagina++; }

            <tbody>

                @foreach (var ocorrencia in aluno.Ocorrencias)
                {
                    var descricaoOcorrencia = ocorrencia.Descricao;
                    int numeroLinhasOcorrencia = CalcularLinhas(descricaoOcorrencia.Length) + CalcularLinhas(ocorrencia.Titulo.Length);
                    int numeroTipoOcorrencia = CalcularLinhas(ocorrencia.Tipo.Length, 17);
                    int totalLinhas = numeroLinhasOcorrencia > numeroTipoOcorrencia ? numeroLinhasOcorrencia : numeroTipoOcorrencia;
                    QuebrarLinhas(totalLinhas, Model.Nome, tituloOcorrencias);

                    MontarCabecalhoOcorrencias(ocorrencia.Data, ocorrencia.Tipo, ocorrencia.Titulo);

                    contadorQuebrarPagina += totalLinhas;
                    <tr>
                        <td class="alinhar-esquerda espaco-esquerda-15">
                            @Html.Raw(MontarOcorrenciasNovo(descricaoOcorrencia, aluno.Nome, tituloOcorrencias, ocorrencia.Data, ocorrencia.Tipo, ocorrencia.Titulo))
                        </td>
                    </tr>

                }
            </tbody>
        </table>

        return "";
    }

    string MontarAssinatura()
    {
        MontarTitulo("ESTOU CIENTE DESTE RELATÓRIO");

        <table class='tabela-alunos'>
            <thead>
                <tr>
                    <td class='centralizar sem-border-bottom negrito'>DATA ASSINATURA</td>
                    <td class='centralizar sem-border-bottom negrito'>ASSINATURA</td>
                </tr>
            </thead>

            @{ contadorQuebrarPagina++; }

            <tbody>
                <tr>
                    <td width="20%" class='centralizar'></td>
                    <td width="80%" class='centralizar'></td>
                </tr>
            </tbody>
        </table>

                    return "";
                }

                string MontarRegistroPercursoCabecalho()
                {
                    return $@"<table class='tabela-alunos sem-border-top'>
<thead>
<tr>
<td width='100%' class='centralizar negrito'>PERCURSO COLETIVO DA TURMA</td>
</tr>
</thead>
<tbody>
<tr>
<td class='alinhar-esquerda espaco-esquerda-15 espaco-esquerda-15'>";
                }

                string MontarRodapeTabela()
                {
                    return @"             </td>
</tr>
</tbody>
</table>";
                }

                void MontarRegistroPercursoNovo(string registroPercursoTurma, string estudante)
                {
        @Html.Raw(MontarRegistroPercursoCabecalho());
        contadorQuebrarPagina++;
        var iContadorCaracteres = 0;

        @while (iContadorCaracteres != registroPercursoTurma.Length)
        {
            if (contadorQuebrarPagina + 1 > contadorMaximoLinhasPorPagina)
            {
                contadorQuebrarPagina = 0;
                @Html.Raw(MontarRodapeTabela());
                @Html.Raw("</tbody></table>");
                @Html.Raw("<div style='page-break-before:always'></div>");

                if (!String.IsNullOrEmpty(estudante))
                {
                    @Html.Raw(MontarTitulo(estudante));
                }

                @Html.Raw(MontarRegistroPercursoCabecalho());
            }
            else
            {
                var qntCaracteresParaBuscar = registroPercursoTurma.Length - iContadorCaracteres < contadorMaximoCaracteresPorLinhaPercurso ? registroPercursoTurma.Length - iContadorCaracteres : contadorMaximoCaracteresPorLinhaPercurso;
                var textParaExibir = registroPercursoTurma.Substring(iContadorCaracteres, qntCaracteresParaBuscar);
                iContadorCaracteres += textParaExibir.Length;

                <span>@Html.Raw(textParaExibir)</span>
           
                contadorQuebrarPagina++;
            }

        }

        @Html.Raw(MontarRodapeTabela());

    }

    MontarEstudantes(Model);
    contadorQuebrarPagina++;

    
    var registroPercursoTurma = Model.RegistroPercursoTurma;
    if (!String.IsNullOrEmpty(registroPercursoTurma))
    {
        MontarRegistroPercursoNovo(registroPercursoTurma, Model.Nome);
    }

    if (Model.Frequencias.Count() > 0)
    {
        QuebrarLinhas(4, Model.Nome);

        if (!quebrou)
        {
            @Html.Raw(EspacoEmBranco())
            contadorQuebrarPagina++;
        }

        MontarFrequencia(Model);
    }

    if (!string.IsNullOrEmpty(Model.PercursoIndividual)) { 
        MontarPercursoIndividual(Model.PercursoIndividual, Model.Nome);
    }

    if (Model.Fotos.Any())
    {
        @Html.Raw(EspacoEmBranco())
        contadorQuebrarPagina++;

        MontarFotos(Model);

        contadorQuebrarPagina = contadorQuebrarPagina + 10;
    }
    else
    {
        contadorMaximoCaracteresPorLinhaPercurso = 210;
    }

    var descricaoObservacoes = Model.Observacoes;
    if (!String.IsNullOrEmpty(descricaoObservacoes))
    {
        int numeroLinhasObservacoes = CalcularLinhas(descricaoObservacoes.Length, 120);

        QuebrarLinhas(numeroLinhasObservacoes + 2, Model.Nome);
        @Html.Raw(EspacoEmBranco())
        contadorQuebrarPagina++;

        MontarObservacoes(Model.Observacoes);
    }

    QuebrarLinhas(4, Model.Nome);

    @Html.Raw(EspacoEmBranco())
    contadorQuebrarPagina++;

    if (Model.Ocorrencias.Count() > 0)
    {
        MontarOcorrencias(Model);
    }

    QuebrarLinhas(3, Model.Nome);
    MontarAssinatura();

    MontarQuebrarPagina();
}