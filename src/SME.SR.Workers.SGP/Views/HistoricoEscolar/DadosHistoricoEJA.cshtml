@using SME.SR.Infra;

@model HistoricoEscolarEJADto

@{
    if (Model.DadosHistorico != null)
    {
        var totalLinhasBaseNacional = ObterTotalLinhasBaseNacional();
        var margemBaseNacional = 5 * totalLinhasBaseNacional;
        <div>
            <table class='tabela margin-top'>
                <tr class="cabecalho-principal">
                    <td class="cabecalho-titulo" colspan="11">@(Model.Cabecalho.LeiFundamental)</td>
                </tr>
                <tr>
                    <th class="texto-vertical" rowspan="@totalLinhasBaseNacional">
                        <p style="width: 48px;margin-left: -@margemBaseNacional%;">BASE NACIONAL COMUM</p>
                    </th>
                    <td class="titulo" style="width: 14.5%;" rowspan="3">Àrea de conhecimento</td>
                    <td class="titulo" style="width: 14.5%;" rowspan="3">Componentes curriculares</td>
                    <td class="titulo" colspan="8">Resultado final</td>
                </tr>
                <tr>
                    <td class="titulo" colspan="2">Alfabetização</td>
                    <td class="titulo" colspan="2">Básica</td>
                    <td class="titulo" colspan="2">Complementar</td>
                    <td class="titulo" colspan="2">Final</td>
                </tr>
                <tr>
                    <td class="texto-centralizado">I</td>
                    <td class="texto-centralizado">II</td>
                    <td class="texto-centralizado">I</td>
                    <td class="texto-centralizado">II</td>
                    <td class="texto-centralizado">I</td>
                    <td class="texto-centralizado">II</td>
                    <td class="texto-centralizado">I</td>
                    <td class="texto-centralizado">II</td>
                </tr>
                @Html.Raw(ObterLinhasBaseNacional())
                @Html.Raw(ObterLinhasDiversificadas())
                @Html.Raw(ObterLinhasEnriquecimentoCurricular())
                @Html.Raw(ObterLinhasProjetosAtividadesComplementares())
                @Html.Raw(ObterLinhasParecerConclusivoFrequenciaGlobal("PARECER CONCLUSIVO", Model.DadosHistorico?.ParecerConclusivo))
            </table>
            @Html.Raw(ObterLegenda())
        </div>
    }


    int ObterTotalLinhasBaseNacional()
    {
        var totalLinhasCabecalho = 4;
        var totalLinhasComponentes = 0;
        var areasConhecimento = Model.DadosHistorico?.BaseNacionalComum?.AreasDeConhecimento;

        if (areasConhecimento == null)
            return totalLinhasComponentes;

        foreach (var areaDeConhecimento in areasConhecimento)
        {
            totalLinhasComponentes += areaDeConhecimento.ComponentesCurriculares.Count();
        }

        return totalLinhasCabecalho + totalLinhasComponentes;
    }

    string ObterLinhasBaseNacional()
    {
        var areasConhecimento = Model.DadosHistorico?.BaseNacionalComum?.AreasDeConhecimento;

        return ObterLinhasAreaDeConhecimento(areasConhecimento);
    }

    string ObterLinhasAreaDeConhecimento(List<AreaDeConhecimentoEJADto> areasConhecimento, bool adicionarPrimeiraLinha = true)
    {
        var linhas = "";

        if (areasConhecimento == null)
            return linhas;

        foreach (var areaDeConhecimento in areasConhecimento)
        {
            var totalComponentes = areaDeConhecimento.ComponentesCurriculares.Count();
            if (adicionarPrimeiraLinha)
                linhas += "<tr>";
            linhas += $"<td class='subTitulo' rowspan='{totalComponentes}'>{areaDeConhecimento.Nome}</td>";
            linhas += ObterLinhasComponentesCurriculares(areaDeConhecimento.ComponentesCurriculares);

            adicionarPrimeiraLinha = true;
        }

        return linhas;
    }

    string ObterLinhasComponentesCurriculares(List<ComponenteCurricularHistoricoEscolarEJADto> componentesCurriculares)
    {
        var linhas = "";
        var adicionarPrimeiraLinha = false;

        if (componentesCurriculares == null)
            return linhas;

        foreach (var componente in componentesCurriculares)
        {
            if (adicionarPrimeiraLinha)
                linhas += "<tr>";
            linhas += $"<td class='subTitulo'>{componente.Nome}</td>";
            linhas += $"<td class='texto-centralizado'>{ObterNotaConceito(componente.NotaConceitoPrimeiraEtapaCiclo1)}</td>";
            linhas += $"<td class='texto-centralizado'>{ObterNotaConceito(componente.NotaConceitoSegundaEtapaCiclo1)}</ td >";
            linhas += $"<td class='texto-centralizado'>{ObterNotaConceito(componente.NotaConceitoPrimeiraEtapaCiclo2)}</td>";
            linhas += $"<td class='texto-centralizado'>{ObterNotaConceito(componente.NotaConceitoSegundaEtapaCiclo2)}</ td >";
            linhas += $"<td class='texto-centralizado'>{ObterNotaConceito(componente.NotaConceitoPrimeiraEtapaCiclo3)}</td>";
            linhas += $"<td class='texto-centralizado'>{ObterNotaConceito(componente.NotaConceitoSegundaEtapaCiclo3)}</ td >";
            linhas += $"<td class='texto-centralizado'>{ObterNotaConceito(componente.NotaConceitoPrimeiraEtapaCiclo4)}</td>";
            linhas += $"<td class='texto-centralizado'>{ObterNotaConceito(componente.NotaConceitoSegundaEtapaCiclo4)}</ td >";
            
            linhas += "</tr>";

            adicionarPrimeiraLinha = true;
        }

        return linhas;
    }

    string ObterNotaConceito(string notaConceito)
    {
        return string.IsNullOrEmpty(notaConceito) ? "-" : notaConceito;
    }

    int ObterTotalLinhasDiversificadas()
    {
        var grupos = Model.DadosHistorico?.GruposComponentesCurriculares;
        var totalLinhasComponentes = 0;

        if (grupos == null)
            return totalLinhasComponentes;

        foreach (var grupo in grupos)
        {
            foreach (var areaConhecimento in grupo.AreasDeConhecimento)
            {
                totalLinhasComponentes += areaConhecimento.ComponentesCurriculares.Count();
            }
        }

        return totalLinhasComponentes;
    }

    string ObterLinhasDiversificadas()
    {
        var grupos = Model.DadosHistorico?.GruposComponentesCurriculares;
        var linhas = "";

        if (grupos != null && grupos.Any())
        {
            linhas = "<tr>";
            linhas += $"<td class='coluna-diversificada' rowspan='{ObterTotalLinhasDiversificadas()}'><p style='width: 48px;'>DIVERSIFICADA</p></td>";

            foreach (var grupo in grupos)
            {
                linhas += ObterLinhasAreaDeConhecimento(grupo.AreasDeConhecimento, false);
            }
        }

        return linhas;
    }

    string ObterLinhasEnriquecimentoCurricular()
    {
        var enriquecimentos = Model.DadosHistorico?.EnriquecimentoCurricular;

        return ObterLinhasAtividadesExtra(enriquecimentos, "Enriquecimento curricular");
    }

    string ObterLinhasProjetosAtividadesComplementares()
    {
        var complementares = Model.DadosHistorico?.ProjetosAtividadesComplementares;

        return ObterLinhasAtividadesExtra(complementares, "Projetos/atividades complementares");
    }

    string ObterLinhasAtividadesExtra(List<ComponenteCurricularHistoricoEscolarEJADto> componentesCurriculares, string nomeAtividade)
    {
        var linhas = "";

        if (componentesCurriculares == null)
            return linhas;

        linhas = "<tr>";
        linhas += $"<td class='subTitulo texto-centralizado' colspan='2' rowspan='{componentesCurriculares.Count()}'>{nomeAtividade}</td>";
        linhas += ObterLinhasComponentesCurriculares(componentesCurriculares);

        return linhas;
    }

    string ObterLinhasParecerConclusivoFrequenciaGlobal(string titulo, ParecerConclusivoEJADto parecerFrequencia)
    {
        var linhas = "";

        if (parecerFrequencia == null)
            return linhas;

        linhas = "<tr>";
        linhas += $"<td class='subTitulo texto-centralizado' colspan='3'>{titulo}</td>";
        linhas += $"<td class='texto-centralizado'>{@parecerFrequencia.PrimeiraEtapaCiclo1}</td>";
        linhas += $"<td class='texto-centralizado'>{@parecerFrequencia.SegundaEtapaCiclo1}</td>";
        linhas += $"<td class='texto-centralizado'>{@parecerFrequencia.PrimeiraEtapaCiclo2}</td>";
        linhas += $"<td class='texto-centralizado'>{@parecerFrequencia.SegundaEtapaCiclo2}</td>";
        linhas += $"<td class='texto-centralizado'>{@parecerFrequencia.PrimeiraEtapaCiclo3}</td>";
        linhas += $"<td class='texto-centralizado'>{@parecerFrequencia.SegundaEtapaCiclo3}</td>";
        linhas += $"<td class='texto-centralizado'>{@parecerFrequencia.PrimeiraEtapaCiclo4}</td>";
        linhas += $"<td class='texto-centralizado'>{@parecerFrequencia.SegundaEtapaCiclo4}</td>";
        linhas += "</tr>";

        return linhas;
    }

    string ObterLegenda()
    {
        var legenda = Model.Legenda;

        if (legenda == null)
            return "";

        return $"<div class='legenda'>C = Conceito, N = Nota, {legenda.Texto}</div>";
    }
}